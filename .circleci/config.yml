version: 2.1

orbs:
  aws-eks: circleci/aws-eks@2.2.0
  kubernetes: circleci/kubernetes@1.3.1

jobs:

  deploy-k8s:
    docker: 
      - image: 'cimg/python:3.10'
    parameters:
      cluster-name:
        description: Name of the EKS cluster
        type: string
        default: 'ngocht-eks'
      workflow_id:
        type: string
        default: '${CIRCLE_WORKFLOW_ID:0:7}'
      docker_image:
        type: string
        default: 'laclac0901/hello:${CIRCLE_WORKFLOW_ID:0:7}'
    steps: 
      - checkout  
      - run: 
          name: create deployment.yml & service.yml file
          command: |
            cat deployment-test.yml | sed "s|DOCKER_IMAGE|<< parameters.docker_image >>|g" > deployment-1.yml
            cat deployment-1.yml | sed "s|ID|<< parameters.workflow_id >>|g" > deployment.yml
            cat service-test.yml | sed "s|ID|<< parameters.workflow_id >>|g" > service.yml
      - run: 
          name: Test result
          command: |
            cat deployment.yml
            cat service.yml
      # - aws-eks/update-kubeconfig-with-authenticator:
      #     cluster-name: << parameters.cluster-name >>
      #     install-kubectl: true
      # - kubernetes/create-or-update-resource:
      #     get-rollout-status: true
      #     resource-file-path: deployment.yml
      #     resource-name: deployment/app
      #     show-kubectl-command: true
      # - kubernetes/create-or-update-resource:
      #     get-rollout-status: true
      #     resource-file-path: service.yml
      #     show-kubectl-command: true

workflows:
  default:
    jobs:
      # - lint
      # - build-docker
      - deploy-k8s